{% extends "base.html" %}

{% block title %}关键词管理 - arXiv论文爬取Agent{% endblock %}

{% block extra_css %}
<style>
    /* 自定义样式 */
    .keyword-card {
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
        position: relative;
        overflow: hidden;
    }

    .keyword-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transition: left 0.5s;
    }

    .keyword-card:hover::before {
        left: 100%;
    }

    .keyword-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-left-color: #0056b3;
    }

    .keyword-tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        display: inline-block;
        margin: 4px;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .keyword-tag:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .keyword-tag .remove-btn {
        margin-left: 8px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .keyword-tag .remove-btn:hover {
        opacity: 1;
    }

    .stats-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
    }

    .action-card {
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .action-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0.5rem;
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }

    .btn-gradient:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .search-box {
        position: relative;
    }

    .search-box input {
        padding-left: 40px;
    }

    .search-box .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fadeInUp 0.5s ease-out;
    }

    /* 响应式优化 */
    @media (max-width: 768px) {
        .keyword-tag {
            font-size: 0.9rem;
            padding: 6px 12px;
            margin: 2px;
        }

        .action-card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="header-gradient">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-tags me-3"></i>关键词管理
                </h1>
                <p class="lead mb-0">智能管理您的科研关键词，精准定位相关论文</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="stats-card card p-3 text-center">
                    <h3 class="mb-1">{{ keywords|length }}</h3>
                    <small>活跃关键词</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row g-4">
        <!-- 添加关键词 -->
        <div class="col-lg-4">
            <div class="action-card card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-plus-circle text-primary me-2"></i>添加关键词
                    </h5>
                    <form method="post" class="mt-3">
                        <input type="hidden" name="action" value="add">
                        <div class="mb-3">
                            <label for="keyword" class="form-label fw-semibold">关键词</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="keyword" name="keyword"
                                       placeholder="例如: machine learning" required>
                                <button class="btn btn-gradient" type="submit">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                支持英文技术术语
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 批量设置 -->
        <div class="col-lg-8">
            <div class="action-card card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-edit text-warning me-2"></i>批量设置关键词
                    </h5>
                    <form method="post" class="mt-3">
                        <input type="hidden" name="action" value="set">
                        <div class="mb-3">
                            <label for="keywords" class="form-label fw-semibold">关键词列表</label>
                            <textarea class="form-control" id="keywords" name="keywords" rows="4"
                                      placeholder="用逗号分隔多个关键词，例如：machine learning, deep learning, neural network">{{ keywords|join(', ') }}</textarea>
                            <div class="form-text d-flex justify-content-between">
                                <span><i class="fas fa-exclamation-triangle me-1"></i>这将替换所有现有关键词</span>
                                <span id="charCount">{{ keywords|join(', ')|length }} 字符</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="fas fa-save me-2"></i>更新所有关键词
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

  <!-- 当前关键词列表 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="action-card card">
                <div class="card-header bg-white border-0 pt-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-layer-group text-info me-2"></i>
                                当前关键词
                                <span class="badge bg-primary ms-2" id="keywordCount">{{ keywords|length }}</span>
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2 justify-content-md-end">
                                <!-- 搜索框 -->
                                <div class="search-box flex-grow-1" style="max-width: 250px;">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="form-control form-control-sm" id="searchKeywords"
                                           placeholder="搜索关键词...">
                                </div>
                                <!-- 批量操作按钮 -->
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="selectAllKeywords()">
                                        <i class="fas fa-check-square"></i> 全选
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteSelectedKeywords()">
                                        <i class="fas fa-trash"></i> 删除选中
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="exportKeywords()">
                                        <i class="fas fa-download"></i> 导出
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if keywords %}
                        <!-- 关键词标签展示 -->
                        <div id="keywordsContainer" class="animate-fade-in">
                            {% for keyword in keywords %}
                                <div class="keyword-tag" data-keyword="{{ keyword|lower }}">
                                    <input type="checkbox" class="form-check-input me-2 keyword-checkbox"
                                           value="{{ keyword }}" style="display: none;">
                                    <span class="keyword-text">{{ keyword }}</span>
                                    <form method="post" class="d-inline" onsubmit="return confirm('确定要删除关键词 "{{ keyword }}" 吗？')">
                                        <input type="hidden" name="action" value="remove">
                                        <input type="hidden" name="keyword" value="{{ keyword }}">
                                        <button type="submit" class="btn btn-link text-white p-0 remove-btn"
                                                style="text-decoration: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                </div>
                            {% endfor %}
                        </div>

                        <!-- 选中操作栏 -->
                        <div id="selectedBar" class="alert alert-info mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>
                                    已选中 <span id="selectedCount">0</span> 个关键词
                                </span>
                                <div>
                                    <button class="btn btn-sm btn-danger me-2" onclick="deleteSelectedKeywords()">
                                        <i class="fas fa-trash me-1"></i>删除选中
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="clearSelection()">
                                        取消选择
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-tags"></i>
                            <h5>暂无关键词</h5>
                            <p class="text-muted">添加关键词以开始爬取相关论文</p>
                            <button class="btn btn-gradient" onclick="document.getElementById('keyword').focus()">
                                <i class="fas fa-plus me-2"></i>添加第一个关键词
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作面板 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="action-card card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-magic text-warning me-2"></i>快速操作
                </h5>
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <button class="btn btn-outline-primary w-100" onclick="addPopularKeywords('ai')">
                            <i class="fas fa-robot me-2"></i>AI热门关键词
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <button class="btn btn-outline-success w-100" onclick="addPopularKeywords('ml')">
                            <i class="fas fa-brain me-2"></i>机器学习
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <button class="btn btn-outline-info w-100" onclick="addPopularKeywords('cv')">
                            <i class="fas fa-eye me-2"></i>计算机视觉
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <button class="btn btn-outline-warning w-100" onclick="addPopularKeywords('nlp')">
                            <i class="fas fa-language me-2"></i>自然语言处理
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 使用建议 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="action-card card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>关键词使用指南
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-rocket me-2"></i>推荐的关键词类型
                            </h6>
                            <div class="keyword-examples">
                                <div class="alert alert-light border-left-primary mb-2">
                                    <strong>技术术语：</strong>
                                    <span class="badge bg-secondary me-1">machine learning</span>
                                    <span class="badge bg-secondary me-1">neural network</span>
                                    <span class="badge bg-secondary me-1">transformer</span>
                                </div>
                                <div class="alert alert-light border-left-success mb-2">
                                    <strong>应用领域：</strong>
                                    <span class="badge bg-success me-1">computer vision</span>
                                    <span class="badge bg-success me-1">natural language processing</span>
                                </div>
                                <div class="alert alert-light border-left-info mb-2">
                                    <strong>方法论：</strong>
                                    <span class="badge bg-info me-1">reinforcement learning</span>
                                    <span class="badge bg-info me-1">supervised learning</span>
                                </div>
                                <div class="alert alert-light border-left-warning mb-0">
                                    <strong>模型架构：</strong>
                                    <span class="badge bg-warning text-dark me-1">GAN</span>
                                    <span class="badge bg-warning text-dark me-1">VAE</span>
                                    <span class="badge bg-warning text-dark me-1">attention mechanism</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success mb-3">
                                <i class="fas fa-magic me-2"></i>使用技巧
                            </h6>
                            <div class="tips-list">
                                <div class="d-flex align-items-start mb-3">
                                    <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                    <div>
                                        <strong>使用英文关键词</strong>
                                        <p class="text-muted small mb-0">arXiv论文主要为英文，英文关键词匹配更准确</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                    <div>
                                        <strong>避免过于宽泛的词汇</strong>
                                        <p class="text-muted small mb-0">避免使用 "AI"、"computer" 等过于宽泛的词汇</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-3">
                                    <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                    <div>
                                        <strong>使用具体技术术语</strong>
                                        <p class="text-muted small mb-0">如 "BERT"、"CNN"、"LSTM" 等具体模型名称</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start mb-0">
                                    <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                                    <div>
                                        <strong>合理的数量范围</strong>
                                        <p class="text-muted small mb-0">建议设置3-10个关键词，平衡覆盖面和精准度</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div> <!-- container 结束 -->

<script>
// 预定义的热门关键词
const popularKeywords = {
    ai: ['artificial intelligence', 'deep learning', 'neural network', 'machine learning', 'transformer', 'BERT', 'GPT'],
    ml: ['machine learning', 'supervised learning', 'unsupervised learning', 'reinforcement learning', 'feature engineering', 'model selection'],
    cv: ['computer vision', 'image recognition', 'object detection', 'image segmentation', 'CNN', 'ResNet', 'YOLO'],
    nlp: ['natural language processing', 'text classification', 'sentiment analysis', 'machine translation', 'attention mechanism', 'language model']
};

// 搜索功能
document.getElementById('searchKeywords').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const keywordTags = document.querySelectorAll('.keyword-tag');

    keywordTags.forEach(tag => {
        const keyword = tag.getAttribute('data-keyword');
        if (keyword.includes(searchTerm)) {
            tag.style.display = 'inline-block';
        } else {
            tag.style.display = 'none';
        }
    });
});

// 字符计数
document.getElementById('keywords').addEventListener('input', function(e) {
    document.getElementById('charCount').textContent = e.target.value.length + ' 字符';
});

// 选择功能
function toggleKeywordSelection(checkbox) {
    const selectedBar = document.getElementById('selectedBar');
    const selectedCount = document.getElementById('selectedCount');
    const checkboxes = document.querySelectorAll('.keyword-checkbox:checked');

    selectedCount.textContent = checkboxes.length;
    selectedBar.style.display = checkboxes.length > 0 ? 'block' : 'none';
}

// 添加点击选择功能
document.querySelectorAll('.keyword-tag').forEach(tag => {
    tag.addEventListener('click', function(e) {
        // 如果点击的是删除按钮，不触发选择
        if (e.target.closest('form')) {
            return;
        }

        const checkbox = this.querySelector('.keyword-checkbox');
        checkbox.checked = !checkbox.checked;
        toggleKeywordSelection(checkbox);

        // 更新视觉反馈
        if (checkbox.checked) {
            this.style.border = '2px solid #007bff';
            this.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
        } else {
            this.style.border = 'none';
            this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
    });
});

// 全选功能
function selectAllKeywords() {
    const checkboxes = document.querySelectorAll('.keyword-checkbox');
    const keywordTags = document.querySelectorAll('.keyword-tag');

    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = true;
        keywordTags[index].style.border = '2px solid #007bff';
        keywordTags[index].style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
    });

    const selectedBar = document.getElementById('selectedBar');
    const selectedCount = document.getElementById('selectedCount');
    selectedCount.textContent = checkboxes.length;
    selectedBar.style.display = 'block';
}

// 清除选择
function clearSelection() {
    const checkboxes = document.querySelectorAll('.keyword-checkbox');
    const keywordTags = document.querySelectorAll('.keyword-tag');

    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = false;
        keywordTags[index].style.border = 'none';
        keywordTags[index].style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    });

    document.getElementById('selectedBar').style.display = 'none';
}

// 删除选中的关键词
function deleteSelectedKeywords() {
    const selectedKeywords = [];
    document.querySelectorAll('.keyword-checkbox:checked').forEach(checkbox => {
        selectedKeywords.push(checkbox.value);
    });

    if (selectedKeywords.length === 0) {
        alert('请先选择要删除的关键词');
        return;
    }

    if (confirm(`确定要删除选中的 ${selectedKeywords.length} 个关键词吗？`)) {
        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'post';

        selectedKeywords.forEach(keyword => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_keywords';
            input.value = keyword;
            form.appendChild(input);
        });

        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'remove_multiple';
        form.appendChild(actionInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// 导出关键词
function exportKeywords() {
    const keywords = [];
    document.querySelectorAll('.keyword-text').forEach(text => {
        keywords.push(text.textContent);
    });

    if (keywords.length === 0) {
        alert('没有可导出的关键词');
        return;
    }

    const data = keywords.join(', ');
    const blob = new Blob([data], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'keywords.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// 添加热门关键词
function addPopularKeywords(category) {
    const keywords = popularKeywords[category];
    const currentKeywords = new Set();

    // 获取当前已有的关键词
    document.querySelectorAll('.keyword-text').forEach(text => {
        currentKeywords.add(text.textContent.toLowerCase());
    });

    // 筛选出新的关键词
    const newKeywords = keywords.filter(keyword => !currentKeywords.has(keyword.toLowerCase()));

    if (newKeywords.length === 0) {
        alert('该类别下的关键词都已存在');
        return;
    }

    // 添加到批量设置文本框
    const textarea = document.getElementById('keywords');
    const currentValue = textarea.value.trim();
    const newValue = currentValue ? currentValue + ', ' + newKeywords.join(', ') : newKeywords.join(', ');
    textarea.value = newValue;

    // 更新字符计数
    document.getElementById('charCount').textContent = newValue.length + ' 字符';

    // 显示提示
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        已添加 ${newKeywords.length} 个关键词到文本框
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    // 3秒后自动消失
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 添加加载动画
    const cards = document.querySelectorAll('.action-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

<style>
.border-left-primary {
    border-left: 4px solid #007bff !important;
}
.border-left-success {
    border-left: 4px solid #28a745 !important;
}
.border-left-info {
    border-left: 4px solid #17a2b8 !important;
}
.border-left-warning {
    border-left: 4px solid #ffc107 !important;
}

.tips-list .d-flex {
    transition: transform 0.2s ease;
}

.tips-list .d-flex:hover {
    transform: translateX(5px);
}

.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}
</style>
{% endblock %}